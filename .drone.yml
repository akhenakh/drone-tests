kind: pipeline
name: build
type: kubernetes

steps:
- name: pr
  image: drone/git
  commands:
  - apk add wget
  - git status
  - date +%s > report.txt
  - git co -b myautobranch
  - git commit -am "Modify tracked file during workflow"
  - wget https://github.com/cli/cli/releases/download/v1.7.0/gh_1.7.0_linux_amd64.tar.gz
  - tar zxvf gh_1.7.0_linux_amd64.tar.gz  gh_1.7.0_linux_amd64/bin/gh
  - ./gh_1.7.0_linux_amd64/bin/gh pr status
  - ./gh_1.7.0_linux_amd64/bin/gh/gh pr create --title "The bug is fixed" --body "Everything works again"
  
- name: test
  image: alpine:3.8
  commands:
  - echo hello
  - exit 2
  
- name: failenv
  image: alpine:3.8
  commands:
  - env
  when:
    status: [ success, failure ]
  depends_on:
    - test
    
- name: mark
  image: akhenakh/drone-deployment-mark:latest
  settings:
    target: prd
    webhook: http://inair.space
  when:
    status: [ success, failure ]
  depends_on:
    - test
---
kind: pipeline
name: test
type: kubernetes

steps:
- name: test2
  image: alpine:3.8
  commands:
  - echo hello 2
  - env
  
- name: test3
  image: alpine:3.8
  commands:
  - echo hello 3
  - env
  
- name: mark3
  image: akhenakh/drone-deployment-mark:latest
  settings:
    target: prd
    webhook: http://inair.space
  when:
    status: [ success, failure ]
